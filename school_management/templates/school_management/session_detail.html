{% extends 'school_management/base.html' %}

{% block title %}{{ session.classroom.class_name }} 第{{ session.session_number }}回 - 学校管理システム{% endblock %}
{% block page_title %}
    {{ session.classroom.class_name }} 第{{ session.session_number }}回詳細
    <span class="fs-6 text-muted">
        （実施日: {{ session.date|date:"Y年m月d日" }}（{{ session.date|date:"l" }}））
    </span>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'school_management:class_list' %}">クラス管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'school_management:class_detail' session.classroom.id %}">{{ session.classroom.class_name }}</a></li>
<li class="breadcrumb-item active" aria-current="page">第{{ session.session_number }}回</li>
{% endblock %}

{% block extra_css %}
<style>
    body { background-color: #f8fafc; }

    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-top: 3px solid #0d6efd;
    }
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% with groups=groups|default:session.group_set.all %}
        <!-- タブナビゲーション -->
        <ul class="nav nav-tabs mb-4" id="sessionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab" aria-controls="content" aria-selected="true">
                    <i class="fas fa-info-circle me-2"></i>授業内容
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="group-tab" data-bs-toggle="tab" data-bs-target="#group" type="button" role="tab" aria-controls="group" aria-selected="false">
                    <i class="fas fa-users me-2"></i>グループ編成
                    {% if groups %}
                        <span class="badge bg-secondary ms-1">{{ groups.count }}</span>
                    {% endif %}
                </button>
            </li>
            {% if session.has_quiz %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quiz-tab" data-bs-toggle="tab" data-bs-target="#quiz" type="button" role="tab" aria-controls="quiz" aria-selected="false">
                    <i class="fas fa-clipboard-check me-2"></i>小テスト管理
                </button>
            </li>
            {% endif %}
            {% if session.has_peer_evaluation %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="peer-tab" data-bs-toggle="tab" data-bs-target="#peer" type="button" role="tab" aria-controls="peer" aria-selected="false">
                    <i class="fas fa-user-friends me-2"></i>ピア評価管理
                </button>
            </li>
            {% endif %}
        </ul>

        <!-- タブコンテンツ -->
        <div class="tab-content" id="sessionTabsContent">
            <!-- 授業内容タブ -->
            <div class="tab-pane fade show active" id="content" role="tabpanel" aria-labelledby="content-tab">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-info-circle me-2"></i>授業内容</h5>
                        <div>
                            <a href="#" class="btn btn-warning btn-sm me-2">
                                <i class="fas fa-qrcode me-1"></i>QR巡回採点
                            </a>
                            <a href="{% url 'school_management:session_delete' session.id %}" class="btn btn-outline-danger btn-sm me-2">
                                <i class="fas fa-trash me-1"></i>削除
                            </a>
                            <a href="{% url 'school_management:class_detail' session.classroom.id %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>クラスに戻る
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-muted">トピック</h6>
                            <p class="fs-5">{{ session.topic|default:"トピック未設定" }}</p>
                        </div>
                        <div class="d-flex gap-4">
                            <div class="d-flex align-items-center">
                                <strong class="me-2">小テスト:</strong>
                                {% if session.has_quiz %}
                                    <span class="badge bg-success">実施予定</span>
                                {% else %}
                                    <span class="badge bg-secondary">なし</span>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2">ピア評価:</strong>
                                {% if session.has_peer_evaluation %}
                                    <span class="badge bg-info">実施予定</span>
                                {% else %}
                                    <span class="badge bg-secondary">なし</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- グループ編成タブ -->
            <div class="tab-pane fade" id="group" role="tabpanel" aria-labelledby="group-tab">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-users me-2"></i>グループ編成</h5>
                        {% if groups %}
                            <span class="badge bg-primary">{{ groups.count }}グループ</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if groups %}
                            <div class="row">
                                {% for group in groups %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <strong><i class="fas fa-layer-group me-2"></i>グループ{{ group.group_number }}</strong>
                                        </div>
                                        <div class="card-body">
                                            {% for member in group.groupmember_set.all %}
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-user me-2 text-primary"></i>
                                                <div>
                                                    <strong>{{ member.student.full_name }}</strong>
                                                    {% if member.role %}
                                                        <span class="badge bg-secondary ms-2">{{ member.role }}</span>
                                                    {% endif %}
                                                    <br>
                                                    <small class="text-muted">{{ member.student.student_number }}</small>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <p class="text-muted mb-0">メンバーが設定されていません</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="{% url 'school_management:group_management' session.id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-edit me-1"></i>グループ編成を編集
                                </a>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">グループが編成されていません</h6>
                                <p class="text-muted">学生をグループに分けて、グループワークやピア評価の準備をしましょう。</p>
                                <a href="{% url 'school_management:group_management' session.id %}" class="btn btn-primary">
                                    <i class="fas fa-users me-1"></i>グループ編成を開始
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 小テスト管理タブ -->
            {% if session.has_quiz %}
            <div class="tab-pane fade" id="quiz" role="tabpanel" aria-labelledby="quiz-tab">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-check me-2"></i>小テスト管理</h5>
                    </div>
                    <div class="card-body">
                        {% if quizzes %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>小テスト名</th>
                                            <th>満点</th>
                                            <th>採点方式</th>
                                            <th>作成日</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for quiz in quizzes %}
                                        <tr class="clickable-row" onclick="window.location=`{% url 'school_management:quiz_detail' quiz.id %}`">
                                            <td><strong>{{ quiz.quiz_name }}</strong></td>
                                            <td>{{ quiz.max_score }}点</td>
                                            <td>
                                                <span class="badge bg-secondary">{{ quiz.get_grading_method_display }}</span>
                                            </td>
                                            <td>{{ quiz.created_at|date:"m/d" }}</td>
                                            <td>
                                                <a href="{% url 'school_management:question_manage' quiz.id %}" class="btn btn-outline-info btn-sm" onclick="event.stopPropagation()">
                                                    <i class="fas fa-clipboard-list me-1"></i>問題管理
                                                </a>
                                                <a href="{% url 'school_management:quiz_grading' quiz.id %}" class="btn btn-outline-success btn-sm" onclick="event.stopPropagation()">
                                                    <i class="fas fa-qrcode me-1"></i>採点
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fas fa-clipboard-plus fa-2x text-muted mb-2"></i>
                                <p class="text-muted">小テストがまだ作成されていません。</p>
                                <a href="{% url 'school_management:quiz_create' session.id %}" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>小テストを作成
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ピア評価管理タブ -->
            {% if session.has_peer_evaluation %}
            <div class="tab-pane fade" id="peer" role="tabpanel" aria-labelledby="peer-tab">
                {% if groups %}
                <div class="card mb-4" id="peer-evaluation-links">
                    <div class="card-header">
                        <h5><i class="fas fa-link me-2"></i>ピア評価リンク</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>学生向けピア評価フォーム</strong><br>
                            以下のリンクを学生に共有して、匿名でピア評価を実施してもらいます。
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>ピア評価用共通リンク:</strong></label>
                            <div class="input-group">
                                <input type="text" class="form-control" 
                                       value="http://{{ request.get_host }}{% url 'school_management:peer_evaluation_common' session.id %}" 
                                       readonly id="peer-link-common">
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="copyToClipboard('peer-link-common')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="form-text">学生はこのリンクから自分のグループを選択して評価を行います。</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card mb-4" id="peer-evaluation-section">
                    <div class="card-header">
                        <h5><i class="fas fa-user-friends me-2"></i>ピア評価管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <i class="fas fa-link fa-2x text-info mb-2"></i>
                                        <h6>匿名評価リンク共有</h6>
                                        <p class="text-muted small">SNS共有画面へ</p>
                                        <a href="{% url 'school_management:peer_evaluation_link' session.id %}" class="btn btn-info btn-sm">
                                            <i class="fas fa-share-alt me-1"></i>リンク共有
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-bar fa-2x text-success mb-2"></i>
                                        <h6>評価結果確認</h6>
                                        <p class="text-muted small">提出された評価の結果を分析</p>
                                        <a href="{% url 'school_management:peer_evaluation_results' session.id %}" class="btn btn-success btn-sm">
                                            <i class="fas fa-chart-line me-1"></i>結果確認
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>ピア評価について</h6>
                            <ul class="mb-0">
                                <li>学生は匿名でグループメンバーの貢献度を評価します</li>
                                <li>他グループの発表内容について順位付けを行います</li>
                                <li>評価者の身元は完全に秘匿されます</li>
                                <li>結果は授業改善とフィードバックに活用されます</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endwith %}
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <a href="{% url 'school_management:class_detail' session.classroom.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>{{ session.classroom.class_name }}に戻る
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(elementId) {
    const copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    // フィードバック表示
    const button = copyText.nextElementSibling;
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check text-success"></i>';
    setTimeout(() => {
        button.innerHTML = originalIcon;
    }, 2000);
}
</script>
{% endblock %}
