{% extends 'school_management/base.html' %}

{% block title %}グループマスタ編集 - {{ classroom.class_name }}{% endblock %}
{% block page_title %}グループマスタ編集{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'school_management:class_list' %}">クラス管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'school_management:class_detail' classroom.id %}">{{ classroom.class_name }}</a></li>
<li class="breadcrumb-item active" aria-current="page">グループマスタ編集</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-layer-group me-2"></i>グループマスタ編集</h5>
                <div>
                    <a href="{% url 'school_management:group_master_list' classroom.id %}" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-list me-1"></i>マスタ一覧
                    </a>
                    <a href="{% url 'school_management:class_detail' classroom.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>クラスに戻る
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3 p-3 bg-light rounded">
                    <h6 class="text-primary mb-2"><i class="fas fa-info-circle me-2"></i>クラス情報</h6>
                    <strong>{{ classroom.class_name }}</strong> - {{ classroom.year }}年 {{ classroom.get_semester_display }}
                </div>

                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>グループマスタについて：</strong>グループマスタは、このクラスの固定グループ編成です。
                    授業回を作成する際に、このマスタからグループをコピーできます。
                    このページで保存すると、既存のグループマスタが全て削除され、新しく作成されます。
                </div>

                <form method="post" id="groupForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="group_count" class="form-label">グループ数</label>
                            <select class="form-control" id="group_count" name="group_count" onchange="updateGroups()">
                                {% if group_masters %}
                                    {% for i in "12345678" %}
                                        <option value="{{ forloop.counter }}" {% if forloop.counter == max_group_number %}selected{% endif %}>
                                            {{ forloop.counter }}グループ
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="2">2グループ</option>
                                    <option value="3">3グループ</option>
                                    <option value="4" selected>4グループ</option>
                                    <option value="5">5グループ</option>
                                    <option value="6">6グループ</option>
                                    <option value="7">7グループ</option>
                                    <option value="8">8グループ</option>
                                {% endif %}
                            </select>
                            {% if group_masters %}
                                <div class="form-text text-info">
                                    <i class="fas fa-info-circle me-1"></i>既存のグループ数: {{ group_masters|length }}グループ（編集フォームに自動読み込み）
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">学生数</label>
                            <div class="form-control-plaintext">
                                <span class="badge bg-info">{{ students.count }}名</span>
                            </div>
                        </div>
                    </div>

                    <div id="groupsContainer">
                        </div>

                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <button type="button" class="btn btn-success btn-sm" onclick="addNewGroup()">
                                <i class="fas fa-plus me-1"></i>グループ追加
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="shuffleMembers()">
                                <i class="fas fa-random me-1"></i>ランダム配置
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAll()">
                                <i class="fas fa-eraser me-1"></i>全クリア
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>グループマスタを保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-user-graduate me-2"></i>学生一覧</h6>
            </div>
            <div class="card-body" id="studentPool">
                {% for student in students %}
                <div class="student-item" 
                     data-student-id="{{ student.student_number }}" 
                     data-student-name="{{ student.full_name }}"
                     draggable="true"
                     ondragstart="drag(event)">
                    <div class="d-flex align-items-center p-2 border rounded mb-2 bg-light">
                        <i class="fas fa-grip-vertical me-2 text-muted"></i>
                        <div>
                            <strong>{{ student.full_name }}</strong><br>
                            <small class="text-muted">{{ student.student_number }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb me-2"></i>使い方</h6>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>グループ数を選択</li>
                    <li>学生をドラッグ＆ドロップでグループに配置</li>
                    <li>必要に応じて役割を設定</li>
                    <li>「グループ編成を保存」をクリック</li>
                </ol>
                <hr>
                <div class="text-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="balanceGroups()">
                        <i class="fas fa-balance-scale me-1"></i>人数均等配置
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const students = [
    {% for student in students %}
    {
        id: "{{ student.student_number }}",
        name: "{{ student.full_name }}"
    },
    {% endfor %}
];

function updateGroups() {
    const groupCount = parseInt(document.getElementById('group_count').value);
    const container = document.getElementById('groupsContainer');
    
    // 既存のグループ情報を保存
    const existingGroupsData = {};
    const groupCountOld = container.querySelectorAll('.card').length || 0;
    
    // 既存のグループからメンバー情報を取得
    for (let i = 1; i <= Math.max(groupCountOld, 20); i++) {
        const membersDiv = document.getElementById(`group_${i}_members`);
        if (membersDiv) {
            const groupNameInput = document.querySelector(`input[name="group_${i}_name"]`);
            const groupName = groupNameInput ? groupNameInput.value : '';
            const members = [];
            
            // メンバー情報を取得
            membersDiv.querySelectorAll('.member-item').forEach((memberItem, index) => {
                const studentIdInput = memberItem.querySelector(`input[name="group_${i}_member_${index}"]`);
                const roleInput = memberItem.querySelector(`input[name="group_${i}_role_${index}"]`);
                const nameElement = memberItem.querySelector('strong');
                
                if (studentIdInput && nameElement) {
                    const studentId = studentIdInput.value;
                    const studentName = nameElement.textContent.trim();
                    const role = roleInput ? roleInput.value : '';
                    members.push({ studentId, studentName, role });
                }
            });
            
            if (members.length > 0 || groupName) {
                existingGroupsData[i] = { groupName, members };
            }
        }
    }
    
    // グループ数が減った場合、削除されるグループのメンバーを学生プールに戻す
    for (let i = groupCount + 1; i <= groupCountOld; i++) {
        if (existingGroupsData[i]) {
            existingGroupsData[i].members.forEach(member => {
                restoreStudentToPool(member.studentId, member.studentName);
            });
        }
    }
    
    // コンテナを完全にクリア
    container.innerHTML = '';
    
    // 新しいグループ構造を作成
    for (let i = 1; i <= groupCount; i++) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'card mb-3';
        groupDiv.innerHTML = `
            <div class="card-header bg-primary text-white d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>グループ ${i}</h6>
                </div>
                <div class="ms-3" style="width: 200px;">
                    <input type="text" class="form-control form-control-sm text-white bg-transparent border-light" 
                           name="group_${i}_name" 
                           placeholder="グループ名（任意）"
                           style="background-color: rgba(255,255,255,0.1) !important;">
                </div>
                <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="removeGroup(${i})" title="グループを削除">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body group-drop-zone" 
                 ondrop="drop(event)" 
                 ondragover="allowDrop(event)" 
                 data-group="${i}">
                <div id="group_${i}_members" class="group-members">
                    </div>
                <div class="text-center text-muted p-3" id="group_${i}_placeholder">
                    <i class="fas fa-user-plus fa-2x mb-2"></i>
                    <p class="mb-0">学生をここにドロップしてください</p>
                </div>
            </div>
        `;
        container.appendChild(groupDiv);
    }
    
    // 既存のグループ情報を復元
    for (let i = 1; i <= groupCount; i++) {
        if (existingGroupsData[i]) {
            const groupData = existingGroupsData[i];
            const groupNameInput = document.querySelector(`input[name="group_${i}_name"]`);
            if (groupNameInput && groupData.groupName) {
                groupNameInput.value = groupData.groupName;
            }
            
            // メンバーを追加
            groupData.members.forEach(member => {
                addMemberToGroup(i, member.studentId, member.studentName, member.role);
            });
        }
    }
    
    // 学生プールを更新
    updateStudentPool();
    
    // グループ数選択肢を更新
    updateGroupCountSelect();
}

function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    ev.dataTransfer.setData("studentId", ev.target.dataset.studentId);
    ev.dataTransfer.setData("studentName", ev.target.dataset.studentName);
}

function drop(ev) {
    ev.preventDefault();
    const studentId = ev.dataTransfer.getData("studentId");
    const studentName = ev.dataTransfer.getData("studentName");
    const groupNum = ev.target.closest('.group-drop-zone').dataset.group;
    
    // 既に他のグループに配置されている場合は削除
    const groupCount = parseInt(document.getElementById('group_count').value) || 20;
    for (let i = 1; i <= groupCount; i++) {
        const membersDiv = document.getElementById(`group_${i}_members`);
        if (membersDiv) {
            membersDiv.querySelectorAll('.member-item').forEach(item => {
                const hiddenInput = item.querySelector(`input[name^="group_${i}_member"]`);
                if (hiddenInput && hiddenInput.value === studentId) {
                    item.remove();
                    // プレースホルダーを表示
                    const placeholder = document.getElementById(`group_${i}_placeholder`);
                    const remainingMembers = membersDiv.querySelectorAll('.member-item').length;
                    if (remainingMembers === 0 && placeholder) {
                        placeholder.style.display = 'block';
                    }
                }
            });
        }
    }
    
    // 学生を元の場所から削除
    const originalElement = document.querySelector(`[data-student-id="${studentId}"]`);
    if (originalElement) {
        originalElement.remove();
    }
    
    // グループにメンバーを追加
    addMemberToGroup(groupNum, studentId, studentName);
}

function addMemberToGroup(groupNum, studentId, studentName, role = '') {
    const membersDiv = document.getElementById(`group_${groupNum}_members`);
    const placeholder = document.getElementById(`group_${groupNum}_placeholder`);
    
    const memberIndex = membersDiv.children.length;
    
    const memberDiv = document.createElement('div');
    memberDiv.className = 'member-item d-flex align-items-center p-2 border rounded mb-2';
    memberDiv.innerHTML = `
        <input type="hidden" name="group_${groupNum}_member_${memberIndex}" value="${studentId}">
        <div class="flex-grow-1">
            <strong>${studentName}</strong><br>
            <small class="text-muted">${studentId}</small>
        </div>
        <div class="ms-2" style="width: 120px;">
            <input type="text" class="form-control form-control-sm" 
                   name="group_${groupNum}_role_${memberIndex}" 
                   placeholder="役割（任意）"
                   value="${role}">
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="removeMember(this, '${studentId}', '${studentName}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    membersDiv.appendChild(memberDiv);
    
    // プレースホルダーを非表示
    if (membersDiv.children.length > 0) {
        placeholder.style.display = 'none';
    }
}

function restoreStudentToPool(studentId, studentName) {
    // 既に学生プールに存在するかチェック
    const existing = document.querySelector(`[data-student-id="${studentId}"]`);
    if (existing) {
        return; // 既に存在する場合は追加しない
    }
    
    const studentPool = document.getElementById('studentPool');
    const studentDiv = document.createElement('div');
    studentDiv.className = 'student-item';
    studentDiv.dataset.studentId = studentId;
    studentDiv.dataset.studentName = studentName;
    studentDiv.draggable = true;
    studentDiv.ondragstart = drag;
    studentDiv.innerHTML = `
        <div class="d-flex align-items-center p-2 border rounded mb-2 bg-light">
            <i class="fas fa-grip-vertical me-2 text-muted"></i>
            <div>
                <strong>${studentName}</strong><br>
                <small class="text-muted">${studentId}</small>
            </div>
        </div>
    `;
    studentPool.appendChild(studentDiv);
}

function removeMember(button, studentId, studentName) {
    // メンバーをグループから削除
    button.parentElement.remove();
    
    // 学生プールに戻す
    restoreStudentToPool(studentId, studentName);
    
    // プレースホルダーの表示/非表示を更新
    const groupNum = button.closest('.group-drop-zone').dataset.group;
    const membersDiv = document.getElementById(`group_${groupNum}_members`);
    const placeholder = document.getElementById(`group_${groupNum}_placeholder`);
    
    if (membersDiv.children.length === 0) {
        placeholder.style.display = 'block';
    }
}

function updateStudentPool() {
    // 全てのグループに配置されている学生IDを取得
    const assignedStudentIds = new Set();
    const groupCount = parseInt(document.getElementById('group_count').value) || 20;
    
    for (let i = 1; i <= groupCount; i++) {
        const membersDiv = document.getElementById(`group_${i}_members`);
        if (membersDiv) {
            membersDiv.querySelectorAll('input[name^="group_' + i + '_member"]').forEach(input => {
                assignedStudentIds.add(input.value);
            });
        }
    }
    
    // 学生プールを再構築
    const studentPool = document.getElementById('studentPool');
    studentPool.innerHTML = '';
    
    students.forEach(student => {
        // グループに配置されていない学生のみ表示
        if (!assignedStudentIds.has(student.id)) {
            restoreStudentToPool(student.id, student.name);
        }
    });
}

function shuffleMembers() {
    // 全てのグループをクリア（確認ダイアログなし）
    const groupCount = parseInt(document.getElementById('group_count').value);
    for (let i = 1; i <= groupCount; i++) {
        const membersDiv = document.getElementById(`group_${i}_members`);
        if (membersDiv) {
            membersDiv.innerHTML = '';
            const placeholder = document.getElementById(`group_${i}_placeholder`);
            if (placeholder) {
                placeholder.style.display = 'block';
            }
        }
    }
    
    // 学生プールを復元
    const studentPool = document.getElementById('studentPool');
    studentPool.innerHTML = '';
    
    students.forEach(student => {
        restoreStudentToPool(student.id, student.name);
    });
    
    // ランダムに配置
    const shuffledStudents = [...students].sort(() => Math.random() - 0.5);
    
    shuffledStudents.forEach((student, index) => {
        const groupNum = (index % groupCount) + 1;
        addMemberToGroup(groupNum, student.id, student.name);
    });
    
    // 学生プールをクリア
    document.getElementById('studentPool').innerHTML = '';
}

function clearAll() {
    if (confirm('全てのグループ編成をクリアしますか？全てのメンバーが学生プールに戻されます。')) {
        // 全てのグループをクリア
        const groupCount = parseInt(document.getElementById('group_count').value);
        for (let i = 1; i <= groupCount; i++) {
            const membersDiv = document.getElementById(`group_${i}_members`);
            if (membersDiv) {
                membersDiv.innerHTML = '';
                const placeholder = document.getElementById(`group_${i}_placeholder`);
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
            }
        }
        
        // 学生プールを復元
        const studentPool = document.getElementById('studentPool');
        studentPool.innerHTML = '';
        
        students.forEach(student => {
            restoreStudentToPool(student.id, student.name);
        });
    }
}

function balanceGroups() {
    if (confirm('人数を均等に配置しますか？')) {
        // 全てのグループをクリア（確認ダイアログなし）
        const groupCount = parseInt(document.getElementById('group_count').value);
        for (let i = 1; i <= groupCount; i++) {
            const membersDiv = document.getElementById(`group_${i}_members`);
            if (membersDiv) {
                membersDiv.innerHTML = '';
                const placeholder = document.getElementById(`group_${i}_placeholder`);
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
            }
        }
        
        // 学生プールを復元
        const studentPool = document.getElementById('studentPool');
        studentPool.innerHTML = '';
        
        students.forEach(student => {
            restoreStudentToPool(student.id, student.name);
        });
        
        const studentsPerGroup = Math.ceil(students.length / groupCount);
        
        students.forEach((student, index) => {
            const groupNum = Math.floor(index / studentsPerGroup) + 1;
            if (groupNum <= groupCount) {
                addMemberToGroup(groupNum, student.id, student.name);
            }
        });
        
        // 学生プールをクリア
        document.getElementById('studentPool').innerHTML = '';
    }
}

function addNewGroup() {
    const container = document.getElementById('groupsContainer');
    const existingGroups = container.querySelectorAll('.card').length;
    const newGroupNumber = existingGroups + 1;
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'card mb-3';
    groupDiv.innerHTML = `
        <div class="card-header bg-primary text-white d-flex align-items-center">
            <div class="flex-grow-1">
                <h6 class="mb-0"><i class="fas fa-users me-2"></i>グループ ${newGroupNumber}</h6>
            </div>
            <div class="ms-3" style="width: 200px;">
                <input type="text" class="form-control form-control-sm text-white bg-transparent border-light" 
                       name="group_${newGroupNumber}_name" 
                       placeholder="グループ名（任意）"
                       style="background-color: rgba(255,255,255,0.1) !important;">
            </div>
            <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="removeGroup(${newGroupNumber})" title="グループを削除">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body group-drop-zone" 
             ondrop="drop(event)" 
             ondragover="allowDrop(event)" 
             data-group="${newGroupNumber}">
            <div id="group_${newGroupNumber}_members" class="group-members">
                </div>
            <div class="text-center text-muted p-3" id="group_${newGroupNumber}_placeholder">
                <i class="fas fa-user-plus fa-2x mb-2"></i>
                <p class="mb-0">学生をここにドロップしてください</p>
            </div>
        </div>
    `;
    
    container.appendChild(groupDiv);
    updateGroupCountSelect();
}

function removeGroup(groupNumber) {
    if (confirm('このグループを削除しますか？グループ内のメンバーは学生プールに戻されます。')) {
        const container = document.getElementById('groupsContainer');
        const groupCard = container.querySelector(`[data-group="${groupNumber}"]`)?.closest('.card');
        
        if (!groupCard) return;
        
        // グループ内のメンバーを学生プールに戻す
        const membersDiv = document.getElementById(`group_${groupNumber}_members`);
        if (membersDiv) {
            membersDiv.querySelectorAll('.member-item').forEach(memberItem => {
                const hiddenInput = memberItem.querySelector(`input[name^="group_${groupNumber}_member"]`);
                const nameElement = memberItem.querySelector('strong');
                if (hiddenInput && nameElement) {
                    const studentId = hiddenInput.value;
                    const studentName = nameElement.textContent.trim();
                    restoreStudentToPool(studentId, studentName);
                }
            });
        }
        
        // グループを削除
        groupCard.remove();
        
        // グループ番号を再計算して更新
        renumberGroups();
        updateGroupCountSelect();
    }
}

function renumberGroups() {
    const container = document.getElementById('groupsContainer');
    const groups = container.querySelectorAll('.card');
    
    groups.forEach((groupCard, index) => {
        const newGroupNumber = index + 1;
        const dropZone = groupCard.querySelector('.group-drop-zone');
        const membersDiv = dropZone.querySelector('.group-members');
        const placeholder = dropZone.querySelector(`[id^="group_"]`);
        const headerTitle = groupCard.querySelector('h6');
        const nameInput = groupCard.querySelector('input[name^="group_"]');
        const removeButton = groupCard.querySelector('button[onclick^="removeGroup"]');
        
        // データ属性を更新
        dropZone.dataset.group = newGroupNumber;
        
        // ヘッダータイトルを更新
        if (headerTitle) {
            headerTitle.innerHTML = `<i class="fas fa-users me-2"></i>グループ ${newGroupNumber}`;
        }
        
        // グループ名入力のname属性を更新
        if (nameInput) {
            nameInput.name = `group_${newGroupNumber}_name`;
        }
        
        // 削除ボタンのonclick属性を更新
        if (removeButton) {
            removeButton.onclick = () => removeGroup(newGroupNumber);
        }
        
        // メンバーのhidden inputのname属性を更新
        if (membersDiv) {
            membersDiv.id = `group_${newGroupNumber}_members`;
            membersDiv.querySelectorAll('input[name^="group_"]').forEach((input, memberIndex) => {
                if (input.name.includes('_member_')) {
                    input.name = `group_${newGroupNumber}_member_${memberIndex}`;
                } else if (input.name.includes('_role_')) {
                    input.name = `group_${newGroupNumber}_role_${memberIndex}`;
                }
            });
        }
        
        // プレースホルダーのIDを更新
        if (placeholder) {
            placeholder.id = `group_${newGroupNumber}_placeholder`;
        }
    });
}

function updateGroupCountSelect() {
    const container = document.getElementById('groupsContainer');
    const currentGroupCount = container.querySelectorAll('.card').length;
    const groupCountSelect = document.getElementById('group_count');
    const currentValue = parseInt(groupCountSelect.value) || 0;
    
    // 現在のグループ数が最大値を超えている場合は選択肢を更新
    const maxOption = Math.max(...Array.from(groupCountSelect.options).map(opt => parseInt(opt.value)));
    
    if (currentGroupCount > maxOption) {
        // 新しい選択肢を追加
        for (let i = maxOption + 1; i <= currentGroupCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}グループ`;
                groupCountSelect.appendChild(option);
            }
        }
    
    // 現在のグループ数に合わせて選択
    groupCountSelect.value = currentGroupCount;
}

// 既存グループデータを保持
const existingGroups = {
    {% if group_masters %}
        {% for group_master in group_masters %}
        {{ group_master.group_number }}: {
            name: "{{ group_master.group_name|escapejs|default:'' }}",
            members: [
                {% for member in group_master.members.all %}
                {
                    id: "{{ member.student.student_number }}",
                    name: "{{ member.student.full_name|escapejs }}",
                    role: "{{ member.role|escapejs|default:'' }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    {% endif %}
};
    
// 初期化
document.addEventListener('DOMContentLoaded', function() {
    {% if group_masters %}
        // 既存のグループがある場合、グループ数を設定
        const maxGroupNumber = {{ max_group_number|default:0 }};
        const groupCountSelect = document.getElementById('group_count');
        
        // 既存のグループ数に合わせて選択肢を設定
        if (maxGroupNumber > 0) {
            // 既存の選択肢をクリア
            groupCountSelect.innerHTML = '';
            
            // 最大グループ番号まで選択肢を追加（最低8まで）
            for (let i = 1; i <= Math.max(maxGroupNumber, 8); i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}グループ`;
                if (i === maxGroupNumber) {
                    option.selected = true;
                }
                groupCountSelect.appendChild(option);
            }
            
            // 既存のグループを構築（updateGroupsではなく直接構築）
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';
            
            // 既存のグループ構造を作成
            {% for group_master in group_masters %}
            (function() {
                const groupNum = {{ group_master.group_number }};
                const groupDiv = document.createElement('div');
                groupDiv.className = 'card mb-3';
                groupDiv.innerHTML = `
                    <div class="card-header bg-primary text-white d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>グループ ${groupNum}</h6>
                        </div>
                        <div class="ms-3" style="width: 200px;">
                            <input type="text" class="form-control form-control-sm text-white bg-transparent border-light" 
                                   name="group_${groupNum}_name" 
                                   placeholder="グループ名（任意）"
                                   style="background-color: rgba(255,255,255,0.1) !important;"
                                   value="{{ group_master.group_name|escapejs|default:'' }}">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="removeGroup(${groupNum})" title="グループを削除">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body group-drop-zone" 
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)" 
                         data-group="${groupNum}">
                        <div id="group_${groupNum}_members" class="group-members">
                            </div>
                        <div class="text-center text-muted p-3" id="group_${groupNum}_placeholder">
                            <i class="fas fa-user-plus fa-2x mb-2"></i>
                            <p class="mb-0">学生をここにドロップしてください</p>
                        </div>
                    </div>
                `;
                container.appendChild(groupDiv);
            })();
            {% endfor %}
            
            // メンバーを追加（役割も一緒に設定）
            {% for group_master in group_masters %}
                {% for member in group_master.members.all %}
                    addMemberToGroup({{ group_master.group_number }}, "{{ member.student.student_number }}", "{{ member.student.full_name|escapejs }}", "{{ member.role|escapejs|default:'' }}");
                {% endfor %}
            {% endfor %}
            
            // 既に配置されている学生を学生プールから削除
            {% for group_master in group_masters %}
                {% for member in group_master.members.all %}
                    const element_{{ member.student.student_number }} = document.querySelector(`[data-student-id="{{ member.student.student_number }}"]`);
                    if (element_{{ member.student.student_number }}) {
                        element_{{ member.student.student_number }}.remove();
                    }
                {% endfor %}
            {% endfor %}
            
            // グループ数選択肢を更新
            updateGroupCountSelect();
        } else {
            // 既存のグループがない場合は通常通りupdateGroups()を呼ぶ
            updateGroups();
            updateGroupCountSelect();
        }
    {% else %}
        // 既存のグループがない場合
        updateGroups();
        updateGroupCountSelect();
    {% endif %}
});
</script>

<style>
.group-drop-zone {
    min-height: 150px;
    border: 2px dashed #ddd;
    transition: all 0.3s ease;
}

.group-drop-zone:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.student-item {
    cursor: move;
    transition: all 0.2s ease;
}

.student-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.member-item {
    background-color: #f8f9fa;
}
</style>
{% endblock %}