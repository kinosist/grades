{% extends 'school_management/base.html' %}

{% block title %}{{ quiz.quiz_name }} - 結果 - 学校管理システム{% endblock %}
{% block page_title %}{{ quiz.quiz_name }} - 結果表示{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'school_management:class_list' %}">クラス管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'school_management:class_detail' quiz.lesson_session.classroom.id %}">{{ quiz.lesson_session.classroom.class_name }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'school_management:lesson_session_detail' quiz.lesson_session.id %}">第{{ quiz.lesson_session.session_number }}回</a></li>
<li class="breadcrumb-item"><a href="{% url 'school_management:quiz_list' quiz.lesson_session.id %}">小テスト一覧</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ quiz.quiz_name }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 統計情報 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar me-2"></i>統計情報</h6>
            </div>
            <div class="card-body">
                {% if stats %}
                <table class="table table-sm table-borderless">
                    <tr>
                        <th>採点完了:</th>
                        <td>{{ stats.graded_students }}/{{ stats.total_students }}名</td>
                    </tr>
                    <tr>
                        <th>平均点:</th>
                        <td>{{ stats.average|floatformat:1 }}点</td>
                    </tr>
                    <tr>
                        <th>最高点:</th>
                        <td>{{ stats.max }}点</td>
                    </tr>
                    <tr>
                        <th>最低点:</th>
                        <td>{{ stats.min }}点</td>
                    </tr>
                    <tr>
                        <th>満点:</th>
                        <td>{{ quiz.max_score }}点</td>
                    </tr>
                </table>
                {% else %}
                <p class="text-muted text-center">まだ採点結果がありません</p>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body text-center">
                <a href="{% url 'school_management:quiz_grading' quiz.id %}" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-edit me-1"></i>採点画面に戻る
                </a>
            </div>
        </div>
    </div>

    <!-- 個別結果 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list me-2"></i>個別結果</h5>
            </div>
            <div class="card-body">
                {% if scores %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>学籍番号</th>
                                <th>氏名</th>
                                <th>得点</th>
                                <th>得点率</th>
                                <th>採点日時</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for score in scores %}
                            <tr>
                                <td>{{ score.student.student_number }}</td>
                                <td>{{ score.student.full_name }}</td>
                                <td>
                                    <strong>{{ score.score }}点</strong>
                                    <small class="text-muted">/ {{ quiz.max_score }}</small>
                                </td>
                                <td>
                                    {% widthratio score.score quiz.max_score 100 as percentage %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar 
                                            {% if percentage >= 80 %}bg-success
                                            {% elif percentage >= 60 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            role="progressbar" 
                                            style="width: {{ percentage }}%;">
                                            {{ percentage }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ score.graded_at|date:"m/d H:i" }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                    <p class="text-muted">まだ採点結果がありません。</p>
                    <a href="{% url 'school_management:quiz_grading' quiz.id %}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>採点を開始
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <a href="{% url 'school_management:session_detail' quiz.lesson_session.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>セッション詳細に戻る
        </a>
    </div>
</div>
{% endblock %}
